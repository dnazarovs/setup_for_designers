services:
  comfyui:
    build: .
    container_name: comfyui
    ports:
      - "8188:8188"
    gpus: all

    env_file:
      - .env

    volumes:
      - ./data/models:/opt/ComfyUI/models
      - ./data/input:/opt/ComfyUI/input
      - ./data/output:/opt/ComfyUI/output

      # ToonCrafter checkpoints (model.ckpt лежит тут и не скачивается повторно)
      - ./data/tooncrafter_checkpoints:/opt/ComfyUI/custom_nodes/ComfyUI-ToonCrafter/ToonCrafter/checkpoints

      # HuggingFace cache (ускоряет будущие загрузки)
      - ./data/hf_cache:/root/.cache/huggingface

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://127.0.0.1:8188/ >/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 10
