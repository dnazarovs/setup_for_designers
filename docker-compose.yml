services:
  comfyui:
    build: .
    container_name: comfyui
    ports:
      - "8188:8188"
    gpus: all
    environment:
      TOONCRAFTER_MODEL_REPO: ${TOONCRAFTER_MODEL_REPO:-Doubiiu/ToonCrafter}
      TOONCRAFTER_MODEL_FILE: ${TOONCRAFTER_MODEL_FILE:-model.ckpt}
      TOONCRAFTER_MODEL_DIR:  ${TOONCRAFTER_MODEL_DIR:-tooncrafter_512_interp_v1}

    volumes:
      - ./data/models:/opt/ComfyUI/models
      - ./data/input:/opt/ComfyUI/input
      - ./data/output:/opt/ComfyUI/output
      - ./data/tooncrafter_checkpoints:/opt/ComfyUI/custom_nodes/ComfyUI-ToonCrafter/ToonCrafter/checkpoints

      # HuggingFace cache (ускоряет будущие загрузки)
      - ./data/hf_cache:/root/.cache/huggingface

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://127.0.0.1:8188/ >/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 10
